ğŸ“ ë©”ì‹œì§€ ì²˜ë¦¬ì„¤ëª…
1. ì´ˆê¸°í™” ê³¼ì •
  Start() í˜¸ì¶œ â†’ HSMS ì—°ê²° ì‹œë„ â†’ ì¥ë¹„ì—ì„œ S1F13 ë³´ë‚´ë©´ S1F14 ì‘ë‹µ.
  ì•ŒëŒ ë³´ê³ (S5F3) ì²˜ë¦¬ í›„ ìƒíƒœë¥¼ INITIALIZEDë¡œ ì „í™˜.
2. ëŸ°íƒ€ì„ ì²˜ë¦¬
  ì¥ë¹„ì—ì„œ Remote Command (S2F41) â†’ ì‘ë‹µ(S2F42) í›„ _rcmdResponseTcs ì™„ë£Œ.
  ë°ì´í„° ë©”ì‹œì§€(S14F3) â†’ ì‘ë‹µ(S14F4) í›„ _dataResponseTcs ì™„ë£Œ.
  ì‹¤íŒ¨ ì‚¬ìœ (S10F3) â†’ ì´ë²¤íŠ¸ ë²„ìŠ¤ë¡œ ì•Œë¦¼ ì „ë‹¬.
3. í˜¸ìŠ¤íŠ¸ ì „ì†¡
  SendMessageAsync(S6F11) â†’ ì´ë²¤íŠ¸ ë¦¬í¬íŠ¸ ì†¡ì‹ .
  ì¥ë¹„ ì‘ë‹µ(S6F12) ìˆ˜ì‹  í›„, Response ê°ì²´ ë°˜í™˜.
4. ì¢…ë£Œ
StopAsync() í˜¸ì¶œ ì‹œ â†’ ì·¨ì†Œ í† í° ë°œí–‰ â†’ Listener ë£¨í”„ ì¢…ë£Œ â†’ ì—°ê²° í•´ì œ.


======
ì½”ë“œ ì„¤ëª…


### 1. í´ë˜ìŠ¤ êµ¬ì¡°

* `SecsGemServer`ëŠ” **SECS/GEM í†µì‹  ì„œë²„ ì—­í• **ì„ ìˆ˜í–‰.
* ìì› ê´€ë¦¬ë¥¼ ìœ„í•´ `IDisposable`, `IAsyncDisposable` ë‘˜ ë‹¤ êµ¬í˜„ â†’
  ë™ê¸°/ë¹„ë™ê¸° í™˜ê²½ ëª¨ë‘ì—ì„œ ì•ˆì „í•˜ê²Œ Dispose ê°€ëŠ¥.

---

### 2. í•„ë“œì™€ ìƒíƒœ ê´€ë¦¬

* `Logger` â†’ `NLog` ê¸°ë°˜ ë¡œê¹….
* `_cts (CancellationTokenSource)` â†’ Start/Stop ì‹œì ë§ˆë‹¤ ìƒˆë¡œ ìƒì„±, ì·¨ì†Œ í† í° ê´€ë¦¬.
* `_listenerTask` â†’ ìˆ˜ì‹  ë©”ì‹œì§€ ë£¨í”„ ì‹¤í–‰ì„ ìœ„í•œ Task.
* `_connector`, `_secsGem` â†’ HSMS ì—°ê²° ê°ì²´ ë° SecsGem í•µì‹¬ ê°ì²´.
* `_rcmdResponseTcs`, `_dataResponseTcs` â†’ ì¥ë¹„ ì‘ë‹µì„ ê¸°ë‹¤ë¦´ ë•Œ ì‚¬ìš©í•˜ëŠ” **ë¹„ë™ê¸° ì‹ í˜¸ê¸°** (`TaskCompletionSource`).
* `SecsGemStatus` â†’ ì„œë²„ ìƒíƒœ (LOAD, CONNECTING, INITIALIZED ë“±).



---

### 3. Start / Stop íë¦„

* `Start`:

  * `SecsGemOptions` ì„¤ì • (`Active/Passive`, IP, í¬íŠ¸, ë²„í¼, Device ID ë“±).
  * `_connector` ìƒì„± í›„ `ConnectionChanged` ì´ë²¤íŠ¸ ë“±ë¡.
  * `_secsGem` ìƒì„± ë° ì—°ê²° ì‹œì‘.
  * ë©”ì‹œì§€ ìˆ˜ì‹  ë£¨í”„ `_listenerTask` ì‹œì‘.
  * ìƒíƒœë¥¼ `CONNECTING`ìœ¼ë¡œ ë³€ê²½.

* `Stop`:

  * `_cts.Cancel()`ë¡œ ë£¨í”„ ì·¨ì†Œ.
  * `_listenerTask` ì¢…ë£Œ ëŒ€ê¸°.
  * `_connector.DisposeAsync()`, `_secsGem.Dispose()`ë¡œ ì •ë¦¬.
  * ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•´ì œ, `TaskCompletionSource` ì •ë¦¬.
  * ìƒíƒœë¥¼ `LOAD`ë¡œ ì´ˆê¸°í™”.

â¡ï¸ **ê°œì„  í¬ì¸íŠ¸:**
ê¸°ì¡´ì—ëŠ” `_cts.Dispose()` í›„ ì¬ì‚¬ìš© ì‹œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆì—ˆìŒ.
ë¦¬íŒ©í„°ë§ í›„ì—ëŠ” Stop ì‹œì ì—ë§Œ Dispose â†’ Start ì‹œ ìƒˆë¡œ ìƒì„±.

---

### 4. Listener ë£¨í”„ (`ListenLoopAsync`)

* `_secsGem.GetPrimaryMessageAsync(ct)`ë¡œ **ë“¤ì–´ì˜¤ëŠ” Primary Messageë¥¼ ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¬ë°**ìœ¼ë¡œ ìˆ˜ì‹ .
* ë©”ì‹œì§€ `S/F` ì½”ë“œì— ë”°ë¼ ë¶„ê¸° ì²˜ë¦¬:

  * `S1F13`: Establish Communication â†’ Reply í›„ ìƒíƒœ `INITIALIZING`.
  * `S5F3`: Alarm Report â†’ Reply í›„ ìƒíƒœ `INITIALIZED`.
  * `S2F41`: Remote Command (RCMD) â†’ Reply í›„ `_rcmdResponseTcs` ì™„ë£Œ.
  * `S14F3`: Data Pass â†’ Reply í›„ `_dataResponseTcs` ì™„ë£Œ.
  * `S10F3`: Fail Reason â†’ Reply í›„ ì´ë²¤íŠ¸ ë²„ìŠ¤ë¡œ `DisplayEvent` ê²Œì‹œ.



---

### 5. SendMessageAsync

```csharp
public async Task<Response> SendMessageAsync(S6F11 message, bool needToResponse = false, int timeoutSeconds = 30)
```

* Primary Message ì „ì†¡ â†’ `_secsGem.SendAsync(...)`.
* **ì‘ë‹µ ëŒ€ê¸° ë°©ì‹:**

  * `needToResponse == true` â†’ `_rcmdResponseTcs` ëŒ€ê¸°.
  * `needToResponse == false` â†’ `_dataResponseTcs` ëŒ€ê¸°.
* `Task.WhenAny`ë¡œ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬.
* ê²°ê³¼ë¥¼ `Response` ê°ì²´ë¡œ ë°˜í™˜.



---

### 6. Dispose / DisposeAsync

* `Dispose`:

  * ë™ê¸° Stop í˜¸ì¶œ.
  * `_secsGem.Dispose()`, `_connector = null`, `TaskCompletionSource` ì •ë¦¬.
* `DisposeAsync`:

  * `StopAsync` í˜¸ì¶œ í›„ ë¡œê±° Dispose.



---


